# Export-SqlServerSchema Configuration File
# This file controls which objects are exported and how they are imported
#
# MINIMAL CONFIG: Every property has a safe default. An empty config file works!
# You only need to specify properties you want to override.

# JSON Schema for validation
$schema: "./export-import-config.schema.json"

# ═══════════════════════════════════════════════════════════════
# GLOBAL SETTINGS (shared by export and import)
# ═══════════════════════════════════════════════════════════════

# Connection timeout in seconds (default: 30)
# How long to wait when establishing initial connection to SQL Server
connectionTimeout: 30

# Command/query timeout in seconds (default: 300 = 5 minutes)
# How long to wait for individual SQL commands to complete
# Increase for large databases or slow operations
commandTimeout: 300

# Maximum retry attempts for transient failures (default: 3)
# Handles network timeouts, Azure SQL throttling, deadlocks
# Set to 1 to disable retries
maxRetries: 3

# Initial retry delay in seconds (default: 2)
# Uses exponential backoff - each retry doubles the delay
# Example: 2s, 4s, 8s for 3 retries
retryDelaySeconds: 2

# Trust server certificate (for self-signed certificates)
# Set to true for:
#   - Local development environments
#   - Docker containers with self-signed certs
#   - SQL Server 2022+ with default encryption
# Set to false for:
#   - Production environments with valid certificates
#   - Environments with proper certificate infrastructure
#
# If you get certificate verification errors, set this to true
trustServerCertificate: false

# Collect performance metrics and save to JSON file (default: false)
# Useful for benchmarking export/import operations
# collectMetrics: false

# Target SQL Server version for generated scripts (default: Sql2022)
# Options: Sql2012, Sql2014, Sql2016, Sql2017, Sql2019, Sql2022
# targetSqlVersion: Sql2022

# ═══════════════════════════════════════════════════════════════
# SIMPLIFIED SETTINGS (root level alternatives to nested settings)
# Command-line parameters ALWAYS override these values
# ═══════════════════════════════════════════════════════════════

# Import mode: Dev (default) or Prod
# - Dev = developer mode (skips infrastructure, safe defaults)
# - Prod = production mode (full import with FileGroups)
# importMode: Dev

# Include table data in export/import (default: false)
# includeData: false

# ═══════════════════════════════════════════════════════════════
# EXPORT CONFIGURATION
# ═══════════════════════════════════════════════════════════════
export:
  # Include table data in export (generates INSERT statements)
  includeData: false

  # Object types to include (if specified, ONLY these types are exported)
  # Mutually exclusive with excludeObjectTypes
  # includeObjectTypes: []

  # Object types to exclude from export
  # By default, ALL object types are exported
  # Uncomment items below to exclude them
  excludeObjectTypes: []
    # - FileGroups                     # Physical storage layout
    # - DatabaseScopedConfigurations   # Performance/optimizer settings
    # - DatabaseScopedCredentials      # External resource credentials
    # - Schemas                        # CREATE SCHEMA statements
    # - Sequences                      # Sequence objects
    # - PartitionFunctions             # Table partitioning functions
    # - PartitionSchemes               # Partition scheme mappings
    # - UserDefinedTypes               # User-defined data types (UDT/UDTT/UDDT)
    # - XmlSchemaCollections           # XML schema definitions
    # - Tables                         # Table definitions (PKs only)
    # - ForeignKeys                    # Foreign key constraints
    # - Indexes                        # Non-clustered indexes
    # - Defaults                       # Default constraints
    # - Rules                          # Rule constraints
    # - Assemblies                     # CLR assemblies
    # - Functions                      # User-defined functions
    # - UserDefinedAggregates          # CLR aggregates
    # - StoredProcedures               # Stored procedures (regular + extended)
    # - DatabaseTriggers               # Database-level triggers
    # - TableTriggers                  # Table-level triggers
    # - Views                          # Database views
    # - Synonyms                       # Object aliases
    # - FullTextSearch                 # Full-text catalogs and stop lists
    # - ExternalData                   # PolyBase data sources and file formats
    # - SearchPropertyLists            # Full-text search properties
    # - PlanGuides                     # Query hint overrides
    # - Security                       # Keys, certificates, roles, users, audits
    # - SecurityPolicies               # Row-Level Security policies

  # Specific objects to exclude (supports wildcards)
  # Pattern: schema.objectname
  excludeObjects: []
    # - "dbo.LegacyTable"              # Exclude specific table
    # - "staging.*"                    # Exclude all objects in staging schema
    # - "*.TempTable"                  # Exclude all TempTable objects

  # Schemas to exclude entirely
  excludeSchemas: []
    # - "staging"                      # Temporary staging area
    # - "temp"                         # Temporary objects
    # - "archive"                      # Old/archived objects

  # File grouping strategy per object type
  # Options: single (default), schema, all
  # - single: One file per object (best for Git tracking)
  # - schema: Group by schema into numbered files (reduces file count)
  # - all: All objects of type in one file (minimal files)
  #
  # NOTE: FileGroups do not support grouping modes - they always export to a single
  # consolidated file (001_FileGroups.sql)
  groupByObjectTypes: {}
    # Sequences: schema                # Group sequences by schema
    # PartitionFunctions: all          # All partition functions in one file
    # PartitionSchemes: all            # All partition schemes in one file
    # UserDefinedTypes: schema         # Group UDTs by schema
    # XmlSchemaCollections: schema     # Group XML schemas by schema
    # Tables: single                   # One file per table (default, best for Git)
    # ForeignKeys: schema              # Group FKs by parent table's schema
    # Indexes: schema                  # Group indexes by parent table's schema
    # Defaults: schema                 # Group defaults by schema
    # Rules: schema                    # Group rules by schema
    # Assemblies: all                  # All assemblies in one file (no schema property)
    # Functions: schema                # Group functions by schema
    # UserDefinedAggregates: schema    # Group CLR aggregates by schema
    # StoredProcedures: schema         # Group stored procs by schema
    # DatabaseTriggers: all            # All database triggers in one file (no schema)
    # TableTriggers: schema            # Group table triggers by parent table's schema
    # Views: schema                    # Group views by schema
    # Synonyms: schema                 # Group synonyms by schema
    # PlanGuides: all                  # All plan guides in one file

  # Parallel export settings (optional)
  parallel:
    enabled: false        # Enable parallel processing (-Parallel switch also enables)
    maxWorkers: 5         # Number of parallel workers (1-20)
    progressInterval: 50  # Report progress every N items

  # Delta/incremental export (optional)
  # Path to previous export for incremental export - only changed objects re-exported
  # deltaFrom: "./exports/localhost_MyDb_20260125_100000"

# ═══════════════════════════════════════════════════════════════
# IMPORT CONFIGURATION
# ═══════════════════════════════════════════════════════════════

import:
  # Default import mode: Dev or Prod
  # Dev = simplified for local development (default)
  # Prod = full production deployment
  defaultMode: Dev

  # Create target database if it does not exist (default: false)
  # Requires appropriate server-level permissions
  # createDatabase: false

  # Skip check for existing schema and apply all scripts (default: false)
  # Use with caution in production
  # force: false

  # Continue applying scripts even if individual scripts fail (default: false)
  # Useful for idempotent applications where some scripts may fail due to existing objects
  # continueOnError: false

  # Display SQL scripts during execution for debugging (default: false)
  # showSql: false

  # Object types to include in import (if specified, only these types are imported)
  # includeObjectTypes: []

  # ─────────────────────────────────────────────────────────────
  # DEPENDENCY RETRY SETTINGS
  # ─────────────────────────────────────────────────────────────
  # Handles cross-object dependencies in programmability objects
  # Example: Function A calls Function B, View X selects from View Y
  dependencyRetries:
    # Enable retry logic for programmability objects (default: true)
    enabled: true

    # Maximum retry attempts (default: 10)
    # If objects still fail after max retries, likely due to syntax errors
    # or missing references outside the retry group
    maxRetries: 10

    # Object types to retry together as a group (default: Functions, StoredProcedures, Views)
    # These are processed with multiple passes to resolve cross-type dependencies
    # For example: Stored procedure queries a view, or function calls another function
    objectTypes:
      - Functions
      - StoredProcedures
      - Views
      # - Synonyms              # Uncomment if synonyms reference other synonyms
      # - TableTriggers         # Uncomment if triggers reference each other
      # - DatabaseTriggers      # Uncomment if database triggers have dependencies

  # ─────────────────────────────────────────────────────────────
  # DEVELOPER MODE SETTINGS (Local Development)
  # ─────────────────────────────────────────────────────────────
  developerMode:
    # FileGroup handling strategy:
    # - 'autoRemap': (default) Import FileGroups, auto-detect data path
    #   Uses SERVERPROPERTY('InstanceDefaultDataPath') to place .ndf files
    #   Preserves FileGroup structure while adapting to local environment
    # - 'removeToPrimary': Skip FileGroups, remap all references to PRIMARY
    #   Simplifies setup by using only PRIMARY FileGroup
    #   All tables/indexes/partitions moved to PRIMARY
    fileGroupStrategy: autoRemap

    # Skip database scoped configurations (use server defaults)
    # Reason: MAXDOP and other settings are hardware-specific
    includeConfigurations: false

    # ALWAYS FALSE: Credentials require manual setup with actual secrets
    includeDatabaseScopedCredentials: false

    # Skip external data sources
    # Reason: Developers may not have access to production Azure resources
    includeExternalData: false

    # Import security policies but keep them DISABLED (STATE=OFF)
    # Reason: Developers need to see all data for debugging
    enableSecurityPolicies: false

    # Skip data import by default (can override with -IncludeData)
    includeData: false

    # Strip FILESTREAM features for Linux/container targets (default: false)
    # FILESTREAM is Windows-only (requires NTFS filesystem integration)
    # When enabled:
    #   - FILESTREAM_ON clauses are removed entirely
    #   - VARBINARY(MAX) FILESTREAM columns become regular VARBINARY(MAX)
    #   - FILESTREAM FileGroups are skipped
    # Required when target is SQL Server on Linux (Docker containers, etc.)
    # Can also use command-line: -StripFilestream
    stripFilestream: false

    # Convert login-mapped users to contained users (WITHOUT LOGIN)
    # Useful when importing to a different server without the same logins
    # convertLoginsToContained: false

    # Object types to exclude in developer mode
    excludeObjectTypes: []
      # - PlanGuides                   # Environment-specific query hints
      # - ExternalLibraries            # ML Services packages

    # FileGroup file size defaults (optional, prevents large allocations on dev systems)
    # If not specified, Dev mode uses safe defaults (1 MB size, 64 MB growth)
    # The source database may have very large file sizes (e.g., 1 GB) that can fail
    # on developer systems with limited disk space
    fileGroupFileSizeDefaults:
      sizeKB: 1024         # Initial file size in KB (1 MB)
      fileGrowthKB: 65536  # File growth increment in KB (64 MB)

  # ─────────────────────────────────────────────────────────────
  # PRODUCTION MODE SETTINGS (Production Deployment)
  # ─────────────────────────────────────────────────────────────
  productionMode:
    # Import FileGroups with path mappings
    fileGroupStrategy: autoRemap

    # Import database scoped configurations
    includeConfigurations: true

    # ALWAYS FALSE: Credentials require manual setup with actual secrets
    includeDatabaseScopedCredentials: false

    # Import external data sources
    includeExternalData: true

    # Enable Row-Level Security policies (STATE=ON)
    enableSecurityPolicies: true

    # Skip data import by default (can override with -IncludeData)
    includeData: false

    # Strip FILESTREAM features (default: false)
    # Usually false for production - FILESTREAM is typically supported on Windows servers
    # Set to true only if production target is SQL Server on Linux
    stripFilestream: false

    # Convert login-mapped users to contained users (default: false)
    # Usually false for production - logins should exist on production servers
    # convertLoginsToContained: false

    # No object types excluded in production mode
    excludeObjectTypes: []

    # FileGroup path mappings (optional for fileGroupStrategy: autoRemap)
    # Paths are auto-detected, but can be overridden if needed
    # Map logical FileGroup names to physical paths on target server
    fileGroupPathMapping:
      FG_CURRENT: "E:\\SQLData\\Current"
      FG_ARCHIVE: "F:\\SQLArchive\\Archive"
      FG_HISTORICAL: "G:\\SQLHistory\\Data"

    # External data source URL replacements
    # Map logical names to environment-specific connection strings
    externalConnectionStrings:
      AzureDataLake: "https://proddatalake.blob.core.windows.net/data"
      AzureBackup: "https://prodbackup.blob.core.windows.net/backup"
      OnPremDataSource: "sqlserver://onprem-server.domain.com/database"

    # FileGroup file size defaults (optional, use source values or custom sizes)
    # In production, you may want larger initial sizes to match capacity planning
    # If not specified, Prod mode uses the original source database values
    fileGroupFileSizeDefaults:
      sizeKB: 1048576       # Initial file size in KB (1 GB)
      fileGrowthKB: 262144  # File growth increment in KB (256 MB)

# ═══════════════════════════════════════════════════════════════
# USAGE EXAMPLES
# ═══════════════════════════════════════════════════════════════

# Export with config file:
# .\Export-SqlServerSchema.ps1 -Server localhost -Database MyDb -ConfigFile export-import-config.yml

# Import in developer mode (default):
# .\Import-SqlServerSchema.ps1 -Server localhost -Database MyDb_Dev -SourcePath .\export -ConfigFile export-import-config.yml

# Import in production mode:
# .\Import-SqlServerSchema.ps1 -Server prodserver -Database MyDb -SourcePath .\export -ImportMode Prod -ConfigFile export-import-config.yml

# Override config file with command-line parameters:
# .\Import-SqlServerSchema.ps1 -Server localhost -Database MyDb_Dev -SourcePath .\export -ConfigFile export-import-config.yml -IncludeConfigurations -EnableSecurityPolicies

# NOTE: Command-line parameters always override config file settings
