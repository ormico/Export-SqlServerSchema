# Export-SqlServerSchema Configuration File
# This file controls which objects are exported and how they are imported

# JSON Schema for validation
$schema: "./export-import-config.schema.json"

# ═══════════════════════════════════════════════════════════════
# CONNECTION SETTINGS
# ═══════════════════════════════════════════════════════════════

# Connection timeout in seconds (default: 30)
# How long to wait when establishing initial connection to SQL Server
connectionTimeout: 30

# Command/query timeout in seconds (default: 300 = 5 minutes)
# How long to wait for individual SQL commands to complete
# Increase for large databases or slow operations
commandTimeout: 300

# Maximum retry attempts for transient failures (default: 3)
# Handles network timeouts, Azure SQL throttling, deadlocks
# Set to 1 to disable retries
maxRetries: 3

# Initial retry delay in seconds (default: 2)
# Uses exponential backoff - each retry doubles the delay
# Example: 2s, 4s, 8s for 3 retries
retryDelaySeconds: 2

# Trust server certificate (for self-signed certificates)
# Set to true for:
#   - Local development environments
#   - Docker containers with self-signed certs
#   - SQL Server 2022+ with default encryption
# Set to false for:
#   - Production environments with valid certificates
#   - Environments with proper certificate infrastructure
# 
# If you get certificate verification errors, set this to true
trustServerCertificate: false

# ═══════════════════════════════════════════════════════════════
# EXPORT CONFIGURATION
# ═══════════════════════════════════════════════════════════════
export:
  # Include table data in export (generates INSERT statements)
  includeData: false
  
  # Object types to exclude from export
  # By default, ALL object types are exported
  # Uncomment items below to exclude them
  excludeObjectTypes: []
    # - FileGroups                     # Physical storage layout
    # - DatabaseScopedConfigurations   # Performance/optimizer settings
    # - DatabaseScopedCredentials      # External resource credentials
    # - Schemas                        # CREATE SCHEMA statements
    # - Sequences                      # Sequence objects
    # - PartitionFunctions             # Table partitioning functions
    # - PartitionSchemes               # Partition scheme mappings
    # - UserDefinedTypes               # User-defined data types (UDT/UDTT/UDDT)
    # - XmlSchemaCollections           # XML schema definitions
    # - Tables                         # Table definitions (PKs only)
    # - ForeignKeys                    # Foreign key constraints
    # - Indexes                        # Non-clustered indexes
    # - Defaults                       # Default constraints
    # - Rules                          # Rule constraints
    # - Assemblies                     # CLR assemblies
    # - Functions                      # User-defined functions
    # - UserDefinedAggregates          # CLR aggregates
    # - StoredProcedures               # Stored procedures (regular + extended)
    # - DatabaseTriggers               # Database-level triggers
    # - TableTriggers                  # Table-level triggers
    # - Views                          # Database views
    # - Synonyms                       # Object aliases
    # - FullTextSearch                 # Full-text catalogs and stop lists
    # - ExternalData                   # PolyBase data sources and file formats
    # - SearchPropertyLists            # Full-text search properties
    # - PlanGuides                     # Query hint overrides
    # - Security                       # Keys, certificates, roles, users, audits
    # - SecurityPolicies               # Row-Level Security policies
  
  # Specific objects to exclude (supports wildcards)
  # Pattern: schema.objectname
  excludeObjects: []
    # - "dbo.LegacyTable"              # Exclude specific table
    # - "staging.*"                    # Exclude all objects in staging schema
    # - "*.TempTable"                  # Exclude all TempTable objects
  
  # Schemas to exclude entirely
  excludeSchemas: []
    # - "staging"                      # Temporary staging area
    # - "temp"                         # Temporary objects
    # - "archive"                      # Old/archived objects

# ═══════════════════════════════════════════════════════════════
# IMPORT CONFIGURATION
# ═══════════════════════════════════════════════════════════════
import:
  # Default import mode: Dev or Prod
  # Dev = simplified for local development (default)
  # Prod = full production deployment
  defaultMode: Dev
  
  # ─────────────────────────────────────────────────────────────
  # DEVELOPER MODE SETTINGS (Local Development)
  # ─────────────────────────────────────────────────────────────
  developerMode:
    # FileGroup handling strategy:
    # - 'autoRemap': (default) Import FileGroups, auto-detect data path
    #   Uses SERVERPROPERTY('InstanceDefaultDataPath') to place .ndf files
    #   Preserves FileGroup structure while adapting to local environment
    # - 'removeToPrimary': Skip FileGroups, remap all references to PRIMARY
    #   Simplifies setup by using only PRIMARY FileGroup
    #   All tables/indexes/partitions moved to PRIMARY
    fileGroupStrategy: autoRemap
    
    # Legacy setting (ignored if fileGroupStrategy is set)
    # Kept for backward compatibility
    includeFileGroups: false
    
    # Skip database scoped configurations (use server defaults)
    # Reason: MAXDOP and other settings are hardware-specific
    includeConfigurations: false
    
    # ALWAYS FALSE: Credentials require manual setup with actual secrets
    includeDatabaseScopedCredentials: false
    
    # Skip external data sources
    # Reason: Developers may not have access to production Azure resources
    includeExternalData: false
    
    # Import security policies but keep them DISABLED (STATE=OFF)
    # Reason: Developers need to see all data for debugging
    enableSecurityPolicies: false
    
    # Skip data import by default (can override with -IncludeData)
    includeData: false
    
    # Object types to exclude in developer mode
    excludeObjectTypes: []
      # - PlanGuides                   # Environment-specific query hints
      # - ExternalLibraries            # ML Services packages

  # ─────────────────────────────────────────────────────────────
  # PRODUCTION MODE SETTINGS (Production Deployment)
  # ─────────────────────────────────────────────────────────────
  productionMode:
    # Import FileGroups with path mappings
    includeFileGroups: true
    
    # Import database scoped configurations
    includeConfigurations: true
    
    # ALWAYS FALSE: Credentials require manual setup with actual secrets
    includeDatabaseScopedCredentials: false
    
    # Import external data sources
    includeExternalData: true
    
    # Enable Row-Level Security policies (STATE=ON)
    enableSecurityPolicies: true
    
    # Skip data import by default (can override with -IncludeData)
    includeData: false
    
    # No object types excluded in production mode
    excludeObjectTypes: []
    
    # FileGroup path mappings (REQUIRED if includeFileGroups=true)
    # Map logical FileGroup names to physical paths on target server
    fileGroupPathMapping:
      FG_CURRENT: "E:\\SQLData\\Current"
      FG_ARCHIVE: "F:\\SQLArchive\\Archive"
      FG_HISTORICAL: "G:\\SQLHistory\\Data"
    
    # External data source URL replacements
    # Map logical names to environment-specific connection strings
    externalConnectionStrings:
      AzureDataLake: "https://proddatalake.blob.core.windows.net/data"
      AzureBackup: "https://prodbackup.blob.core.windows.net/backup"
      OnPremDataSource: "sqlserver://onprem-server.domain.com/database"

# ═══════════════════════════════════════════════════════════════
# USAGE EXAMPLES
# ═══════════════════════════════════════════════════════════════

# Export with config file:
# .\Export-SqlServerSchema.ps1 -Server localhost -Database MyDb -ConfigFile export-import-config.yml

# Import in developer mode (default):
# .\Import-SqlServerSchema.ps1 -Server localhost -Database MyDb_Dev -SourcePath .\export -ConfigFile export-import-config.yml

# Import in production mode:
# .\Import-SqlServerSchema.ps1 -Server prodserver -Database MyDb -SourcePath .\export -ImportMode Prod -ConfigFile export-import-config.yml

# Override config file with command-line parameters:
# .\Import-SqlServerSchema.ps1 -Server localhost -Database MyDb_Dev -SourcePath .\export -ConfigFile export-import-config.yml -IncludeConfigurations -EnableSecurityPolicies

# NOTE: Command-line parameters always override config file settings
