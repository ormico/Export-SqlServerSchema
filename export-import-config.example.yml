# Export-SqlServerSchema Configuration File
# This file controls which objects are exported and how they are imported
#
# MINIMAL CONFIG: Every property has a safe default. An empty config file works!
# You only need to specify properties you want to override.
#
# DETAILED DOCUMENTATION: docs/CONFIG_REFERENCE.md
#    Complete property reference, types, examples, and troubleshooting

# JSON Schema for validation
$schema: "./export-import-config.schema.json"

# ═══════════════════════════════════════════════════════════════
# GLOBAL SETTINGS (shared by export and import)
# ═══════════════════════════════════════════════════════════════

# Connection timeout in seconds (default: 30)
# How long to wait when establishing initial connection to SQL Server
connectionTimeout: 30

# Command/query timeout in seconds (default: 300 = 5 minutes)
# How long to wait for individual SQL commands to complete
# Increase for large databases or slow operations
commandTimeout: 300

# Maximum retry attempts for transient failures (default: 3)
# Handles network timeouts, Azure SQL throttling, deadlocks
# Set to 1 to disable retries
maxRetries: 3

# Initial retry delay in seconds (default: 2)
# Uses exponential backoff - each retry doubles the delay
# Example: 2s, 4s, 8s for 3 retries
retryDelaySeconds: 2

# Trust server certificate (for self-signed certificates)
# Set to true for:
#   - Local development environments
#   - Docker containers with self-signed certs
#   - SQL Server 2022+ with default encryption
# Set to false for:
#   - Production environments with valid certificates
#   - Environments with proper certificate infrastructure
#
# If you get certificate verification errors, set this to true
trustServerCertificate: false

# ─────────────────────────────────────────────────────────────
# CONNECTION SECTION (environment variable credential injection)
# Useful for containers, CI/CD, and any environment where
# credentials are supplied as environment variables.
# ─────────────────────────────────────────────────────────────
#
# Option 1: Individual env vars for each connection component
# connection:
#   serverFromEnv: SQLCMD_SERVER        # name of env var holding the server address
#   usernameFromEnv: SQLCMD_USER        # name of env var holding the username
#   passwordFromEnv: SQLCMD_PASSWORD    # name of env var holding the password
#   trustServerCertificate: true        # trust self-signed certs (containers)
#
# Option 2: Single full ADO.NET connection string in one env var
# Useful for Azure App Service SQLCONNSTR_* variables, GitHub Actions secrets, etc.
# The connection string is parsed to extract Server, Database, credentials, and
# TrustServerCertificate. Individual CLI params always override connection string values.
# connection:
#   connectionStringFromEnv: SQLCONNSTR_Default  # name of env var with full connection string
#
# Precedence (high to low):
#   -Server/-Database/-Credential (CLI) >
#   -ServerFromEnv/-UsernameFromEnv/-PasswordFromEnv (CLI) >
#   -ConnectionStringFromEnv (CLI) >
#   connection.serverFromEnv / connection.usernameFromEnv / connection.passwordFromEnv (config) >
#   connection.connectionStringFromEnv (config) >
#   defaults

# Collect performance metrics and save to JSON file (default: false)
# Useful for benchmarking export/import operations
# collectMetrics: false

# Target SQL Server version for generated scripts (default: Sql2022)
# Options: Sql2012, Sql2014, Sql2016, Sql2017, Sql2019, Sql2022
# targetSqlVersion: Sql2022

# ═══════════════════════════════════════════════════════════════
# SIMPLIFIED SETTINGS (root level alternatives to nested settings)
# Command-line parameters ALWAYS override these values
# ═══════════════════════════════════════════════════════════════

# Import mode: Dev (default) or Prod
# - Dev = developer mode (skips infrastructure, safe defaults)
# - Prod = production mode (full import with FileGroups)
# importMode: Dev

# Include table data in export/import (default: false)
# includeData: false

# ═══════════════════════════════════════════════════════════════
# EXPORT CONFIGURATION
# ═══════════════════════════════════════════════════════════════
export:
  # Include table data in export (generates INSERT statements)
  includeData: false

  # Object types to include (if specified, ONLY these types are exported)
  # Mutually exclusive with excludeObjectTypes
  # includeObjectTypes: []

  # Object types to exclude from export
  # By default, ALL object types are exported
  # Uncomment items below to exclude them
  excludeObjectTypes: []
    # - FileGroups                     # Physical storage layout
    # - DatabaseScopedConfigurations   # Performance/optimizer settings
    # - DatabaseScopedCredentials      # External resource credentials
    # - Schemas                        # CREATE SCHEMA statements
    # - Sequences                      # Sequence objects
    # - PartitionFunctions             # Table partitioning functions
    # - PartitionSchemes               # Partition scheme mappings
    # - UserDefinedTypes               # User-defined data types (UDT/UDTT/UDDT)
    # - XmlSchemaCollections           # XML schema definitions
    # - Tables                         # Table definitions (PKs only)
    # - ForeignKeys                    # Foreign key constraints
    # - Indexes                        # Non-clustered indexes
    # - Defaults                       # Default constraints
    # - Rules                          # Rule constraints
    # - Assemblies                     # CLR assemblies
    # - Functions                      # User-defined functions
    # - UserDefinedAggregates          # CLR aggregates
    # - StoredProcedures               # Stored procedures (regular + extended)
    # - DatabaseTriggers               # Database-level triggers
    # - TableTriggers                  # Table-level triggers
    # - Views                          # Database views
    # - Synonyms                       # Object aliases
    # - FullTextCatalogs               # Full-text catalogs
    # - FullTextStopLists              # Full-text stop lists
    # - ExternalDataSources            # PolyBase external data sources
    # - ExternalFileFormats            # PolyBase external file formats
    # - SearchPropertyLists            # Full-text search properties
    # - PlanGuides                     # Query hint overrides
    # - Certificates                   # Database certificates
    # - AsymmetricKeys                 # Asymmetric keys
    # - SymmetricKeys                  # Symmetric keys
    # - ColumnMasterKeys               # Always Encrypted column master keys
    # - ColumnEncryptionKeys           # Always Encrypted column encryption keys
    # - SecurityPolicies               # Row-Level Security policies

  # Specific objects to exclude (supports wildcards)
  # Pattern: schema.objectname
  excludeObjects: []
    # - "dbo.LegacyTable"              # Exclude specific table
    # - "staging.*"                    # Exclude all objects in staging schema
    # - "*.TempTable"                  # Exclude all TempTable objects

  # Schemas to exclude entirely
  excludeSchemas: []
    # - "staging"                      # Temporary staging area
    # - "temp"                         # Temporary objects
    # - "archive"                      # Old/archived objects

  # File grouping strategy per object type
  # Options: single (default), schema, all
  # - single: One file per object (best for Git tracking)
  # - schema: Group by schema into numbered files (reduces file count)
  # - all: All objects of type in one file (minimal files)
  #
  # NOTE: FileGroups do not support grouping modes - they always export to a single
  # consolidated file (001_FileGroups.sql)
  groupByObjectTypes: {}
    # Sequences: schema                # Group sequences by schema
    # PartitionFunctions: all          # All partition functions in one file
    # PartitionSchemes: all            # All partition schemes in one file
    # UserDefinedTypes: schema         # Group UDTs by schema
    # XmlSchemaCollections: schema     # Group XML schemas by schema
    # Tables: single                   # One file per table (default, best for Git)
    # ForeignKeys: schema              # Group FKs by parent table's schema
    # Indexes: schema                  # Group indexes by parent table's schema
    # Defaults: schema                 # Group defaults by schema
    # Rules: schema                    # Group rules by schema
    # Assemblies: all                  # All assemblies in one file (no schema property)
    # Functions: schema                # Group functions by schema
    # UserDefinedAggregates: schema    # Group CLR aggregates by schema
    # StoredProcedures: schema         # Group stored procs by schema
    # DatabaseTriggers: all            # All database triggers in one file (no schema)
    # TableTriggers: schema            # Group table triggers by parent table's schema
    # Views: schema                    # Group views by schema
    # Synonyms: schema                 # Group synonyms by schema
    # PlanGuides: all                  # All plan guides in one file

  # Parallel export settings (optional)
  parallel:
    enabled: false        # Enable parallel processing (-Parallel switch also enables)
    maxWorkers: 5         # Number of parallel workers (1-20)
    progressInterval: 50  # Report progress every N items

  # Delta/incremental export (optional)
  # Path to previous export for incremental export - only changed objects re-exported
  # deltaFrom: "./exports/localhost_MyDb_20260125_100000"

  # Strip FILESTREAM features from exported scripts (default: false)
  # FILESTREAM is Windows-only (requires NTFS filesystem integration)
  # When enabled, the exported scripts are pre-processed to remove:
  #   - FILESTREAM_ON clauses from table definitions
  #   - FILESTREAM keyword from VARBINARY(MAX) column definitions
  #   - FILESTREAM FileGroup definitions and related ADD FILE batches
  # Use this when targeting SQL Server on Linux (Docker containers, etc.)
  # This is an alternative to import-time stripping (import.*.stripFilestream)
  # Can also use command-line: -StripFilestream
  # stripFilestream: false

# ═══════════════════════════════════════════════════════════════
# IMPORT CONFIGURATION
# ═══════════════════════════════════════════════════════════════

import:
  # Default import mode: Dev or Prod
  # Dev = simplified for local development (default)
  # Prod = full production deployment
  defaultMode: Dev

  # Create target database if it does not exist (default: false)
  # Requires appropriate server-level permissions
  # createDatabase: false

  # Skip check for existing schema and apply all scripts (default: false)
  # Use with caution in production
  # force: false

  # Continue applying scripts even if individual scripts fail (default: false)
  # Useful for idempotent applications where some scripts may fail due to existing objects
  # continueOnError: false

  # Display SQL scripts during execution for debugging (default: false)
  # showSql: false

  # Auto-select the most recent valid export from a parent directory (default: false)
  # When true, -SourcePath is treated as a parent and the latest export subfolder
  # (by exportStartTimeUtc in _export_metadata.json, or LastWriteTime as fallback) is used.
  # Equivalent to passing -UseLatestExport on the command line.
  # useLatestExport: false

  # Object types to include in import (if specified, only these types are imported)
  # includeObjectTypes: []

  # ─────────────────────────────────────────────────────────────
  # DEPENDENCY RETRY SETTINGS
  # ─────────────────────────────────────────────────────────────
  # Handles cross-object dependencies in programmability objects
  # Example: Function A calls Function B, View X selects from View Y
  dependencyRetries:
    # Enable retry logic for programmability objects (default: true)
    enabled: true

    # Maximum retry attempts (default: 10)
    # If objects still fail after max retries, likely due to syntax errors
    # or missing references outside the retry group
    maxRetries: 10

    # Object types to retry together as a group (default: Functions, StoredProcedures, Views)
    # These are processed with multiple passes to resolve cross-type dependencies
    # For example: Stored procedure queries a view, or function calls another function
    objectTypes:
      - Functions
      - StoredProcedures
      - Views
      # - Synonyms              # Uncomment if synonyms reference other synonyms
      # - TableTriggers         # Uncomment if triggers reference each other
      # - DatabaseTriggers      # Uncomment if database triggers have dependencies

  # ─────────────────────────────────────────────────────────────
  # DEVELOPER MODE SETTINGS (Local Development)
  # ─────────────────────────────────────────────────────────────
  developerMode:
    # FileGroup handling strategy:
    # - 'autoRemap': (default) Import FileGroups, auto-detect data path
    #   Uses SERVERPROPERTY('InstanceDefaultDataPath') to place .ndf files
    #   Preserves FileGroup structure while adapting to local environment
    # - 'removeToPrimary': Skip FileGroups, remap all references to PRIMARY
    #   Simplifies setup by using only PRIMARY FileGroup
    #   All tables/indexes/partitions moved to PRIMARY
    fileGroupStrategy: autoRemap

    # Skip database scoped configurations (use server defaults)
    # Reason: MAXDOP and other settings are hardware-specific
    includeConfigurations: false

    # ALWAYS FALSE: Credentials require manual setup with actual secrets
    includeDatabaseScopedCredentials: false

    # Skip external data sources
    # Reason: Developers may not have access to production Azure resources
    includeExternalData: false

    # Import security policies but keep them DISABLED (STATE=OFF)
    # Reason: Developers need to see all data for debugging
    enableSecurityPolicies: false

    # Skip data import by default (can override with -IncludeData)
    includeData: false

    # Strip FILESTREAM features for Linux/container targets (default: false)
    # FILESTREAM is Windows-only (requires NTFS filesystem integration)
    # When enabled:
    #   - FILESTREAM_ON clauses are removed entirely
    #   - VARBINARY(MAX) FILESTREAM columns become regular VARBINARY(MAX)
    #   - FILESTREAM FileGroups are skipped
    # Required when target is SQL Server on Linux (Docker containers, etc.)
    # Can also use command-line: -StripFilestream
    stripFilestream: false

    # Strip Always Encrypted features for targets without external key stores (default: false)
    # Always Encrypted uses external key stores (Azure Key Vault, Windows Certificate Store, etc.)
    # When enabled:
    #   - ENCRYPTED WITH clauses are removed from column definitions
    #   - CREATE COLUMN MASTER KEY and CREATE COLUMN ENCRYPTION KEY statements are skipped
    #   - Encrypted columns become regular (unencrypted) columns
    # Required when target lacks access to the original key store (e.g., Linux Docker containers)
    # Can also use command-line: -StripAlwaysEncrypted
    stripAlwaysEncrypted: false

    # Convert login-mapped users to contained users (WITHOUT LOGIN)
    # Useful when importing to a different server without the same logins
    # convertLoginsToContained: false

    # CLR Integration Settings
    # Controls CLR assembly loading behavior during import.
    # SQL Server 2017+ defaults to clr strict security = 1, which blocks
    # unsigned/untrusted CLR assemblies from loading.
    # clr:
    #   enableClr: true                         # Enable CLR integration (sp_configure 'clr enabled')
    #   disableStrictSecurityForImport: true     # Temporarily disable strict security during CLR import
    #   restoreStrictSecuritySetting: true       # Restore original strict security value after import
    #   restoreClrEnabledSetting: true           # Restore original CLR enabled value after import

    # Object types to exclude in developer mode
    excludeObjectTypes: []
      # - PlanGuides                   # Environment-specific query hints
      # - ExternalLibraries            # ML Services packages

    # FileGroup file size defaults (optional, prevents large allocations on dev systems)
    # If not specified, Dev mode uses safe defaults (1 MB size, 64 MB growth)
    # The source database may have very large file sizes (e.g., 1 GB) that can fail
    # on developer systems with limited disk space
    fileGroupFileSizeDefaults:
      sizeKB: 1024         # Initial file size in KB (1 MB)
      fileGrowthKB: 65536  # File growth increment in KB (64 MB)

    # ─────────────────────────────────────────────────────────────
    # ENCRYPTION SECRETS (Dev Mode)
    # ─────────────────────────────────────────────────────────────
    # Passwords for encryption objects (Database Master Key, Symmetric Keys, etc.)
    # Required when importing databases that use encryption features.
    #
    # Secret sources (in order of security):
    #   1. env: Read from environment variable (recommended)
    #   2. file: Read from file (good for containers/Kubernetes)
    #   3. value: Inline value (DEVELOPMENT ONLY - never commit to git!)
    #
    # WARNING: Inline 'value' secrets are for development only.
    # Never use inline secrets in production or commit them to version control.
    encryptionSecrets:
      # Database Master Key - required if database uses any encryption
      databaseMasterKey:
        value: "DevMasterKeyPwd!123"    # DEV ONLY - use env: in production

      # Symmetric key passwords (key name -> secret)
      symmetricKeys:
        DataEncryptionKey:
          value: "DevSymKeyPwd!123"     # DEV ONLY
        # BackupKey:
        #   env: SQL_BACKUP_KEY_PWD     # Read from environment variable

      # Certificate private key passwords (for certs with private keys)
      # certificates:
      #   DataCert:
      #     env: SQL_DATACERT_PASSWORD

      # Application role passwords
      applicationRoles:
        TestAppRole:
          value: "TestAppRolePwd!123"   # DEV ONLY

  # ─────────────────────────────────────────────────────────────
  # PRODUCTION MODE SETTINGS (Production Deployment)
  # ─────────────────────────────────────────────────────────────
  productionMode:
    # Import FileGroups with path mappings
    fileGroupStrategy: autoRemap

    # Import database scoped configurations
    includeConfigurations: true

    # ALWAYS FALSE: Credentials require manual setup with actual secrets
    includeDatabaseScopedCredentials: false

    # Import external data sources
    includeExternalData: true

    # Enable Row-Level Security policies (STATE=ON)
    enableSecurityPolicies: true

    # Skip data import by default (can override with -IncludeData)
    includeData: false

    # Strip FILESTREAM features (default: false)
    # Usually false for production - FILESTREAM is typically supported on Windows servers
    # Set to true only if production target is SQL Server on Linux
    stripFilestream: false

    # Strip Always Encrypted features (default: false)
    # Usually false for production - key stores should be available on production servers
    # Set to true only if production target lacks access to the original key store
    stripAlwaysEncrypted: false

    # Convert login-mapped users to contained users (default: false)
    # Usually false for production - logins should exist on production servers
    # convertLoginsToContained: false

    # CLR Integration Settings (production)
    # Usually not needed in production if assemblies are properly signed
    # clr:
    #   enableClr: true                         # Enable CLR if target needs it
    #   disableStrictSecurityForImport: false    # Production should use signed assemblies
    #   restoreStrictSecuritySetting: true       # Always restore in production
    #   restoreClrEnabledSetting: true           # Always restore in production

    # No object types excluded in production mode
    excludeObjectTypes: []

    # FileGroup path mappings (optional for fileGroupStrategy: autoRemap)
    # Paths are auto-detected, but can be overridden if needed
    # Map logical FileGroup names to physical paths on target server
    fileGroupPathMapping:
      FG_CURRENT: "E:\\SQLData\\Current"
      FG_ARCHIVE: "F:\\SQLArchive\\Archive"
      FG_HISTORICAL: "G:\\SQLHistory\\Data"

    # External data source URL replacements
    # Map logical names to environment-specific connection strings
    externalConnectionStrings:
      AzureDataLake: "https://proddatalake.blob.core.windows.net/data"
      AzureBackup: "https://prodbackup.blob.core.windows.net/backup"
      OnPremDataSource: "sqlserver://onprem-server.domain.com/database"

    # FileGroup file size defaults (optional, use source values or custom sizes)
    # In production, you may want larger initial sizes to match capacity planning
    # If not specified, Prod mode uses the original source database values
    fileGroupFileSizeDefaults:
      sizeKB: 1048576       # Initial file size in KB (1 GB)
      fileGrowthKB: 262144  # File growth increment in KB (256 MB)

    # ─────────────────────────────────────────────────────────────
    # ENCRYPTION SECRETS (Production Mode)
    # ─────────────────────────────────────────────────────────────
    # SECURITY: Production secrets should ALWAYS use env: or file: sources.
    # NEVER use inline 'value' secrets in production configs!
    #
    # For Kubernetes/containers, use mounted secrets as files:
    #   - Mount secret as volume at /secrets/
    #   - Reference with file: "/secrets/dbmasterkey.txt"
    #
    # For traditional deployments, use environment variables:
    #   - Set SQL_MASTER_KEY_PWD in system/service environment
    #   - Reference with env: "SQL_MASTER_KEY_PWD"
    encryptionSecrets:
      # Database Master Key
      databaseMasterKey:
        env: SQL_MASTER_KEY_PWD         # From environment variable
        # Or for containers:
        # file: "/secrets/dbmasterkey.txt"

      # Symmetric key passwords
      symmetricKeys:
        DataEncryptionKey:
          env: SQL_DATA_KEY_PWD
        BackupEncryptionKey:
          file: "/secrets/backup-key.txt"   # For Kubernetes secrets

      # Certificate private key passwords
      certificates:
        DataCert:
          env: SQL_DATACERT_PASSWORD
        SigningCert:
          file: "/secrets/signing-cert-pwd.txt"

      # Application role passwords
      applicationRoles:
        App_ReadOnly:
          env: SQL_APPROLE_READONLY_PWD
        App_Admin:
          env: SQL_APPROLE_ADMIN_PWD

# ═══════════════════════════════════════════════════════════════
# USAGE EXAMPLES
# ═══════════════════════════════════════════════════════════════

# Export with config file:
# .\Export-SqlServerSchema.ps1 -Server localhost -Database MyDb -ConfigFile export-import-config.yml

# Import in developer mode (default):
# .\Import-SqlServerSchema.ps1 -Server localhost -Database MyDb_Dev -SourcePath .\export -ConfigFile export-import-config.yml

# Import in production mode:
# .\Import-SqlServerSchema.ps1 -Server prodserver -Database MyDb -SourcePath .\export -ImportMode Prod -ConfigFile export-import-config.yml

# Override config file with command-line parameters:
# .\Import-SqlServerSchema.ps1 -Server localhost -Database MyDb_Dev -SourcePath .\export -ConfigFile export-import-config.yml -IncludeConfigurations -EnableSecurityPolicies

# NOTE: Command-line parameters always override config file settings
